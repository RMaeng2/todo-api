<!doctype html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Todo UI</title>
</head>
<body>
<h1>Todo UI</h1>

<section>
    <h2>할 일 추가</h2>
    <input id="title" type="text" placeholder="할 일을 입력하세요"/>
    <button id="addBtn">추가</button>
</section>

<hr/>

<section>
    <h2>목록</h2>
    <button id="refreshBtn">새로고침</button>
    <ul id="todoList"></ul>
</section>

<script>
    async function fetchTodos() {
        const res = await fetch("/todos");
        if (!res.ok) {
            alert("목록 조회 실패: " + res.status);
            return;
        }
        const todos = await res.json();
        renderTodos(todos);
    }

    function renderTodos(todos) {
        const ul = document.getElementById("todoList");
        ul.innerHTML = "";

        todos.forEach(t => {
            const li = document.createElement("li");
            li.style.marginBottom = "8px";

            const text = document.createElement("span");
            text.textContent = `#${t.id} ${t.title} (completed: ${t.completed}) `;
            li.appendChild(text);

            const completeBtn = document.createElement("button");
            completeBtn.textContent = "완료";
            completeBtn.onclick = async () => {
                const res = await fetch(`/todos/${t.id}`, { method: "PATCH" });
                if (!res.ok) {
                    alert("완료 처리 실패: " + res.status);
                    return;
                }
                await fetchTodos();
            };
            li.appendChild(completeBtn);

            const deleteBtn = document.createElement("button");
            deleteBtn.textContent = "삭제";
            deleteBtn.style.marginLeft = "6px";
            deleteBtn.onclick = async () => {
                const res = await fetch(`/todos/${t.id}`, { method: "DELETE" });
                if (!res.ok) {
                    alert("삭제 실패: " + res.status);
                    return;
                }
                await fetchTodos();
            };
            li.appendChild(deleteBtn);

            ul.appendChild(li);
        });
    }

    document.getElementById("addBtn").onclick = async () => {
        const title = document.getElementById("title").value.trim();
        if (!title) {
            alert("title을 입력하세요");
            return;
        }
        const res = await fetch("/todos", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ title })
        });
        if (!res.ok) {
            const text = await res.text();
            alert("생성 실패: " + res.status + "\n" + text);
            return;
        }
        document.getElementById("title").value = "";
        await fetchTodos();
    };

    document.getElementById("refreshBtn").onclick = fetchTodos;

    // 최초 로드
    fetchTodos();
</script>
</body>
</html>
